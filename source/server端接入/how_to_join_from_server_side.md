**百度智能小程序**

**业务端开源能力接入方案**

背景说明
========

本方案针对智能小程序全面开源后，为所有开源联盟成员方如何在小程序平台业务端完整实施对接提供专向解决方案说明，以方便实施推进。

业务端开源能力全景图
====================

**角色说明**：

-   **联盟组织者(百度)**：统一负责的小程序帐号注册，资质提交，基础资质审核，物料提交与基础审核、小程序包基础审核，管理与分发、小程序核心库，非标准扩展库的管理与分发等。

-   **联盟成员**：提供APP宿主(集成小程序运行库)、开发个性组件

-   **小程序开发者**：开发、发布、运营小程序 或 委托TP开发

-   **TP（三方开发者**）：代开发、代发布、代运营小程序（TP可以视为高级开发者）

-   **小程序开源框架开发者**：优化开源代码、组件扩展

-   **第三方服务商**：提供第三方数据、广告、云服务能力

![](image/flow.png)

业务端接入流程
==============

整体功能用例图
==============

**名词说明：**

-   开源联盟平台：开放给开源联盟成员使用，提供统一访问入口。

-   百度小程序开发者平台：
    百度负责运维的平台，开放给所有的开发者使用，提供小程序所有管理能力

-   developer.baidu.com（百度开放平台)：
    百度对外开放生态能力的平台门户，提供统一API服务入口

-   百度小程序审核平台：提供统一的基础审核能力，包括资质，物料与小程序包)

-   小程序应用市场(PMS):
    提供统一的swan框架包，非标扩展包，小程序包管理与分发能力

![](image/register_from_server.png)

API设计说明
===========

>   开放给联盟成员平台使用的API，统一走百度开放平台(developer.baidu.com)进行Open
>   API授权后才能访问。

方案参见： <https://smartprogram.baidu.com/docs/develop/server/power_exp/>

协议 统一使用https+json POST提交方式。

入参通过json 格式 以body方式提交， 返回结果也统一使用json格式返回

接口功能与设计
==============

页面与API列表如下：

| API / 功能            | 说明                                                                    | 角色           | 平台                 | 能力要求      |
|-----------------------|-------------------------------------------------------------------------|----------------|----------------------|---------------|
| 注册联盟成员          |                                                                         | 开源联盟成员   | 开源联盟平台         | 页面          |
| 提交物料格式          | 宿主app对小程序分发物料的内容要求。 物料内容： 文字， 图片， 链接，视频 | 开源联盟成员   | 开源联盟平台         | 页面/API      |
| 提交渠道入口说明文档  |                                                                         | 开源联盟成员   | 开源联盟平台         | 页面/API      |
| 查看开源文档          |                                                                         | 开源联盟成员   | 开源联盟平台         | 页面          |
| 提交APP兼容性测试服务 | 提供给宿主APP进行小程序基准兼容性测试能力                               | 开源联盟成员   | 开源联盟平台         | 页面/API      |
| 发布小程序扩展包      | 由每个宿主APP单独管理，PMS统一分发。 extendsion.js                      | 开源联盟成员   | 开源联盟平台         | 页面/API      |
| 数据订阅服务          | 指标统计数据，打点数据                                                  | 联盟成员业务端 | 开源联盟平台         | API/异步Kafka |
| 资质查询服务          | 获取资质内容(只有通过基础审核的资质才能查询)                            | 联盟成员业务端 | 开源联盟平台         | 页面/API      |
| 物料查询服务          | 获取物料信息(只有通过基础审核的物料才能查询)                            | 联盟成员业务端 | 开源联盟平台         | 页面/API      |
| 小程序包状态查询服务  | 查询小程序包的状态，包括审核状态，风控状态等                            | 联盟成员业务端 | 开源联盟平台         | 页面/API      |
| 小程序包状态同步服务  | 同步小程序审核状态，风控状态等                                          | 联盟成员业务端 | 开源联盟平台         | API/异步Kafka |
| 小程序包下载          |                                                                         | app端          | PMS                  | API           |
| warncore框架包下载    |                                                                         | app端          | PMS                  | API           |
| 宿主扩展包下载        |                                                                         | app端          | PMS                  | API           |
| 打点数据上传          | 提供统一SDK库(android/IOS)                                              | app端          | 百度小程序开发者平台 | API           |
|                       |                                                                         |                |                      |               |

### 基础接入能力

1.  **注册联盟成员**

**页面功能， 提供给开源联盟成员在页面上注册，注册成功后，会返回ak, sk,**
"officalNo":"开源联盟成员标识,数字类型"。

同时可以增加APP注册， 每个APP，会有独立的 "containerNo":"联盟宿主app标识,
数字类型"

![](image/usecases)

1.  **发布小程序扩展包**

>   **API/页面 该功能是开放给开源联盟成员提交非标的swanjs框架的扩展包发布能力。
>   扩展包会通过基准测试后，推送到PMS服务上，以提供给宿主APP包更新下载使用**

>   **Path: / api/deployPackage**

>   **入参**

| **字段**           | **类型** | **必填** | **描述**                                                             |
|--------------------|----------|----------|----------------------------------------------------------------------|
| containerNo        | 数字字符 | yes      | **宿主id标识**                                                       |
| swanCoreExt        | string   | yes      | **Extendsion.js扩展包二进制包内容** 需要对byte流进行base64编码后传入 |
| swanCoreVersion    | string   | yes      | **对应的swancore版本号**                                             |
| swanCoreExtVersion | string   | yes      | **Extendsion.js扩展包版本号**                                        |

>   **响应体字段：**

| **参数** | **类型** | **必填** | **描述**      |
|----------|----------|----------|---------------|
| status   | 数字     | yes      | 0成功， 1失败 |
| message  | string   | no       | 信息说明      |

### 扩展接入能力

1.  **提交物料格式**

>   **API 功能说明：
>   提供给开源联盟成员管理员提交其宿主APP发布小程序时需要的物料内容要求。**

>   **Path: /api/setPosterInfoFormat**

>   **入参**

| **字段**             | **类型** | **必填** | **描述**                                                                                                                                           |
|----------------------|----------|----------|----------------------------------------------------------------------------------------------------------------------------------------------------|
| containerNo          | 数字字符 | yes      | **宿主id标识**                                                                                                                                     |
| **posterInfoFormat** | JSON     | yes      | **物料格式 String JSON格式, 数组 [{ “type":"",**  **"desc": "", }] “type":"", 物料格式,** (text)， 图片(pic)，视频(video) **"desc": "", 物料说明** |

>   **响应体字段：**

| **参数** | **类型** | **必填** | **描述**      |
|----------|----------|----------|---------------|
| status   | 数字     | yes      | 0成功， 1失败 |
| message  | string   | no       | 信息说明      |

1.  **提交渠道入口说明文档**

>   **页面功能**

1.  提交APP兼容性测试服务

>   **API/页面功能是开放给开源联盟成员来验证开源实现的APP在小程序框架的兼容性能力进行验证测试。**

>   **Path: /api/ctsTest**

>   **会有提交次数限制，每天x次。**

>   **入参**

| **字段**    | **类型** | **必填** | **描述**                                             |
|-------------|----------|----------|------------------------------------------------------|
| containerNo | 数字字符 | yes      | **宿主id标识**                                       |
| appContent  | string   | yes      | **App二进制包内容** 需要对byte流进行base64编码后传入 |
| appVersion  | string   | yes      | **App版本号**                                        |
| platform    | string   | yes      | **App操作系统 IOS Android carlife**                  |

>   **响应体字段：**

| **参数** | **类型** | **必填** | **描述**      |
|----------|----------|----------|---------------|
| status   | 数字     | yes      | 0成功， 1失败 |
| message  | string   | no       | 信息说明      |

1.  **查看开源文档**

>   **页面功能**

1.  **资质查询服务**

>   **API/页面 由开发者设置授权后，提供给开源联盟成员查询开发者的资质信息.**

>   **Path: /api/queryQualification**

>   **入参**

| **字段**  | **类型** | **必填** | **描述**               |
|-----------|----------|----------|------------------------|
| officalNo | 数字字符 | yes      | **开源联盟成员id标识** |
| companyId | string   | yes      | 开发者id. (passportid) |

>   **响应体字段：**

| **参数** | **类型**    | **必填** | **描述**                                        |
|----------|-------------|----------|-------------------------------------------------|
| status   | 数字        | yes      | 0成功， 1失败                                   |
| message  | string      | no       | 信息说明                                        |
| data     | JSON string | no       | 资质信息。 { “result”: // zip文件包base64编码 } |

1.  **批量资质查询服务**

>   **API由开发者设置授权后，提供给开源联盟成员查询开发者的资质信息.**

>   **Path: /api/batchQueryQualification**

>   **入参**

| **字段**   | **类型** | **必填** | **描述**                            |
|------------|----------|----------|-------------------------------------|
| officalNo  | 数字字符 | yes      | **开源联盟成员id标识**              |
| companyIds | string   | yes      | 开发者id. (passportid), 多个用,分隔 |

>   **响应体字段：**

| **参数** | **类型**    | **必填** | **描述**                                                |
|----------|-------------|----------|---------------------------------------------------------|
| status   | 数字        | yes      | 0成功， 1失败                                           |
| message  | string      | no       | 信息说明                                                |
| data     | JSON string | no       | 资质信息。 { “result”: [] // 数组 zip文件包base64编码 } |

1.  **物料查询服务**

>   **API/页面 由开发者设置授权后，提供给开源联盟成员查询开发者的物料信息.**

>   **Path: /api/queryPosterInfo**

>   **入参**

| **字段**         | **类型** | **必填** | **描述**               |
|------------------|----------|----------|------------------------|
| officalNo        | 数字字符 | yes      | **开源联盟成员id标识** |
| companyId        | string   | yes      | 开发者id. (passportid) |
| **smartAppKeys** | string   | yes      | 小程序id, 多个用，分隔 |

>   **响应体字段：**

| **参数** | **类型**    | **必填** | **描述**                                                 |
|----------|-------------|----------|----------------------------------------------------------|
| status   | 数字        | yes      | 0成功， 1失败                                            |
| message  | string      | no       | 信息说明                                                 |
| data     | JSON string | no       | **物料格式 String JSON格式,**  **{ companyId:””, data:** |
|          |             |          |                                                          |

>   **[{**

>   **smartAppKey:””, 小程序key**

>   **posterInfos: [{ //数组**

>   **path:””,**

>   **title: “” //标题**

>   **posterInfo: [{ //数组 物料详细信息**

>   **“type":"",**

>   **"desc": "",**

>   **“value”:””**

>   **]},**

>   **}],**

>   **}]**

**}**

**Path: 智能小程序内页链接 /pages/index/index**

**“type":"", 物料格式,**文字(text)， 图片(pic)，视频(video), 音频(sound)

**"desc": "", 物料说明**

**“value”: “” string类型 ，图片，视频文件base64编码**

1.  **批量物料查询服务**

>   **API 由开发者设置授权后，提供给开源联盟成员查询开发者的物料信息.**

>   **Path: /api/batchQueryPosterInfo**

>   **入参**

| **字段**        | **类型** | **必填** | **描述**                             |
|-----------------|----------|----------|--------------------------------------|
| officalNo       | 数字字符 | yes      | **开源联盟成员id标识**               |
| companyId       | string   | yes      | 开发者id. (passportid), 多个用，分隔 |
| **smartAppKey** | string   | yes      | 小程序id                             |

>   **响应体字段：**

| **参数** | **类型**    | **必填** | **描述**                                                  |
|----------|-------------|----------|-----------------------------------------------------------|
| status   | 数字        | yes      | 0成功， 1失败                                             |
| message  | string      | no       | 信息说明                                                  |
| data     | JSON string | no       | **物料格式 String JSON格式, 数组 [{ companyId:””, data:** |

>   **[{**

>   **smartAppKey:””, 小程序key**

>   **posterInfos: [{ //数组**

>   **path:””,**

>   **title: “” //标题**

>   **posterInfo: [{ //数组 物料详细信息**

>   **“type":"",**

>   **"desc": "",**

>   **“value”:””**

>   **]},**

>   **}],**

>   **}]**

**}]**

**“type":"", 物料格式,**文字(text)， 图片(pic)，视频(video), 音频(sound)

**"desc": "", 物料说明**

**“value”: “” string类型 ，图片，视频文件base64编码**

1.  **小程序包状态查询服务**

>   **API/页面 由开发者设置授权后，提供给开源联盟成员查询开发者的小程序包状态.**

>   **Path : /api/querySmartAppPackageStatus**

>   **入参**

| **字段**        | **类型** | **必填** | **描述**         |
|-----------------|----------|----------|------------------|
| containerNo     | 数字字符 | yes      | **宿主id标识**   |
| smartAppKey     | string   | yes      | 小程序包key      |
| smartAppVersion | string   | yes      | **小程序包版本** |
|                 |          |          |                  |

>   **响应体字段：**

| **参数** | **类型**    | **必填** | **描述**                                                                   |
|----------|-------------|----------|----------------------------------------------------------------------------|
| status   | 数字        | yes      | 0成功， 1失败                                                              |
| message  | string      | no       | 信息说明                                                                   |
| data     | JSON string | no       | { “result”: //状态信息 } 0审核成功，1审核失败， -1未知状态，小程序包不存在 |

1.  **小程序包状态批量查询服务**

**API 由开发者设置授权后，提供给开源联盟成员查询开发者的小程序包状态.**

>   **Path : /api/batchQuerySmartAppPackageStatus**

**入参**

| **字段**         | **类型** | **必填** | **描述**                                                   |
|------------------|----------|----------|------------------------------------------------------------|
| containerNo      | 数字字符 | yes      | **宿主id标识**                                             |
| smartAppKeys     | string   | yes      | 小程序包key， 多个用,分隔                                  |
| smartAppVersions | string   | yes      | **小程序包版本,多个用,分隔， 数量必须与samrtAppKeys相同**  |
|                  |          |          |                                                            |

**响应体字段：**

| **参数** | **类型**    | **必填** | **描述**                                                                                                     |
|----------|-------------|----------|--------------------------------------------------------------------------------------------------------------|
| status   | 数字        | yes      | 0成功， 1失败                                                                                                |
| message  | string      | no       | 信息说明                                                                                                     |
| data     | JSON string | no       | { “results”: []//状态信息,数组，与请求小程序keys个数对应 } 0审核成功，1审核失败， -1未知状态，小程序包不存在 |

1.  **小程序包状态同步服务**

>   **API/页面
>   提供给开盟联盟业务端平台提交小程序包状态给统一平台，以保障有风险的小程序包在开源联盟生态中可以统一控制.
>   状态包括但不仅限，审核通过，审核失败（原因），风控下线（原因）,监控报警状态**

>   **Path : /api/syncSmartAppPackageStatus**

>   **入参**

| **字段**           | **类型** | **必填** | **描述**                                                     |
|--------------------|----------|----------|--------------------------------------------------------------|
| officalNo          | 数字字符 | yes      | **开源联盟成员id标识**                                       |
| containerNo        | 数字字符 | no       | **宿主id标识**                                               |
| smartAppKey        | string   | yes      | 小程序包key                                                  |
| smartAppVersion    | string   | yes      | **小程序包版本**                                             |
| smartAppStatus     | 数据     | Yes      | 0 正常状态 1异常状态                                         |
| smartAppStatusDesc | string   | yes      | 状态说明 **审核失败（原因），风控下线（原因）,监控报警状态** |

>   **响应体字段：**

| **参数** | **类型** | **必填** | **描述**      |
|----------|----------|----------|---------------|
| status   | 数字     | yes      | 0成功， 1失败 |
| message  | string   | no       | 信息说明      |
|          |          |          |               |

1.  **数据订阅服务**

>   **可以订阅 全量宿主的打点数据日志以及标准化处理后的指标数据日志。**

>   **支持同步与异步两种方式。**

>   **同步： API订阅， 返回JSON内容包。（离线）**

>   **Path : /api/getLogData**

>   **入参**

| **字段**    | **类型** | **必填** | **描述**                           |
|-------------|----------|----------|------------------------------------|
| containerNo | 数字字符 | yes      | **宿主id标识**                     |
| beginDate   | Date日志 | yes      | **开始时间(天)区间(小于等于昨天)** |
| endDate     | Date日志 | yes      | **结束时间(天)区间(小于等于昨天)** |

>   **响应体字段：**

| **参数** | **类型**    | **必填** | **描述**                                               |
|----------|-------------|----------|--------------------------------------------------------|
| status   | 数字        | yes      | 0成功， 1失败                                          |
| message  | string      | no       | 信息说明                                               |
| data     | JSON string | no       | { “result”: //离线文件bos url链接 } 审核成功，审核失败 |

>   **异步： Kafka访问， 内容JSON序列化。（实时）**

1.  **打点数据上传**

**API . 提供统一的SDK(android/IOS)库支持。接入文档后续补充**
