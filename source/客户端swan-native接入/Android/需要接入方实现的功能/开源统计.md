#### 功能说明

在小程序发布之后，为了能够在后期根据用户的使用情况和程序的运行情况做适当的调整，不断优化小程序，当前提供一个开源数据统计方案。

开源统计会在小程序运行的各个关键点和运行轨迹上埋下事件点，包括功能逻辑和业务逻辑，打点方式有普通打点和流式打点两种。事件打点可通过onEvent直接记录，调用之后即可将当前的数据上报到服务端；流失打点通过Flow对象在以时间点为横轴的数据轨迹上插入多个事件，每个事件均支持设置自定义数据，在一串事件流结束之后，可将整个流上报至服务端。

#### 使用指南

开源统计框架支持两种接入方式：使用百度提供的统计服务；使用自定义的统计服务。默认会使用百度的统计服务，同时可以通过实现接口的方式自定义数据格式和上报的服务器。以下分别讲述两种接入方式：

在事件和流统计完成之后，通过IUBCUploader接口中的uploadData方法上报，在此接口中可以实现数据的整合、加密、编码以及上报的C/S协议和相关细节

1. 首先创建上报接口对象，此接口仅用于上报打点统计数据：


```java
IUBCUploader newOpenStatUploader();
```

**参数说明：**

- 返回值：上报接口

2. 上报打点数据。将埋下的点上报，可以在此接口中实现数据的加密、C/S上报协议，并且可以写入服务器地址

```java
/**
     * UBC 上行打点数据流程。
     *
     * @param jsonArray  上传的参数
     * @return 是否上传成功
     */
    boolean uploadData(JSONArray jsonArray);
```

**参数说明：**

- jsonArray：需要上报的统计数据

- 返回值：是否上报成功。如果没有上报成功，会将数据写在本地数据库中，待后续时机再次尝试上报；如果上报成功，不会保存。

#### 实现示例

```java
public boolean uploadData(JSONArray jsonArray) {
    
	Map<String, String> header = new HashMap<>(HEADER_COUNT);
    header.put(key1, value1);
    header.put(key2, value2);
	// 拼装http header
    ...
	Request request = getOkHttpRequest(header, jsonArray);
        if (mOkHttpClient == null) {
            mOkHttpClient = createOkHttpClient();
        }
    // 发起http请求，上报打点数据
        Call call = mOkHttpClient.newCall(request);
 	Response response = call.execute();
    // 处理服务端response
....
}
```

### 实现参考

- demo使用了系统的实现，参见/demo/src/main/java/com/baidu/swan/demo/swan/impl/

### 打点格式

打点分为普通打点和流式打点两种形式，分别用于记录一个时间点的单独事件和以时间为轴一连串事件。格式分别如下：

1、普通打点格式

```json
{ 
// 手机系统基本信息
"system": {
    "os":"平台 - IOS, Android",
    "osversion":"系统版本",
    "model":"机型信息",
    "deviceType":"机型类型:1 phone  2 pad  3 carplay",
    "sdk":"系统SDK版本（Android）",
    "brand":"厂商信息（Android）",
    "screen":"设备宽高信息 width_height格式",
    "density":"屏幕密度",
},
// 开源信息
"officialNo":"开源联盟成员标识,数字类型",
"containerNo":"联盟宿主app标识, 数字类型",
 // app信息
"appVersion":"宿主手百app版本",
"appBranch":"手百矩阵产品标识，比如lite版，青春版等",
"appPackageName":"？自己用到ext里",
// 用户信息
"uuid":"设备id，统计UV",
"clientIp":"来源ip，服务端bfe会获取，放到header里，端上不用关心",
// 网络和地域
"net":"",  //wifi, 2g, 3g, 4g, 5g
"operator":"运营商：联通，电信等",
"location": { // 地域，可选
    "accuracy": "40",
    "horizontalAccuracy": "40",
    "latitude": "40.041912",
    "longitude": "116.266266",
    "speed": "-1",
    "verticalAccuracy": "0"
},
// 小程序基本信息
"smartAppId":"GLyLQW5hu1hvrakX0dh1E1wpRT2SPI9F_dev5774", // 小程序id, string类型
"smartAppVersion":"小程序包版本,字符串",
"swanCoreVersion":"swan框架版本",
"swanType":"",  // swan/swangame，小程序或者小游戏 
"swanId":"待确认",
// 小程序事件相关信息
"bizId":"xxx", //统计事件ID，类似ubcid，根据bizId可以在管理端找到这个事件相关描述和业务含义
"eventType":"1",  //日志类型:0—普通事件类  1—时序事件类型
"eventName":"show@duration", // 事件名称:, 下载包异常，js异常，支付，自定义等
"startTime":"1456994549932", //事件上报的时间戳，单位：毫秒，整数
"endTime":"1456994549932", //事件上报的时间戳，单位：毫秒，整数
"srvTimestamp":"1456994549932", // 接收服务器时间戳，接收服务器来打，放到header里，端上不用关心
 //事件内容字段，跟具体业务相关
 "content":{
      "duration":"3", // 3s
      "ext" : {
          "thirdversion": "v1.1.0.0",
          "needdown": "0"
      }    
  }
}
```



2、流式打点格式

```json
{ 
// 手机系统基本信息
"system": {
    "os":"平台 - IOS, Android",
    "osversion":"系统版本",
    "model":"机型信息",
    "deviceType":"机型类型:1 phone  2 pad  3 carplay",
    "sdk":"系统SDK版本（Android）",
    "brand":"厂商信息（Android）",
    "screen":"设备宽高信息 width_height格式",
    "density":"屏幕密度",
},
// 开源信息
"officialNo":"开源联盟成员标识,数字类型",
"containerNo":"联盟宿主app标识, 数字类型",
 // app信息
"appVersion":"宿主手百app版本",
"appBranch":"手百矩阵产品标识，比如lite版，青春版等",
"appPackageName":"？自己用到ext里",
// 用户信息和来源ip
"uuid":"设备id，统计UV",
"clientIp":"来源ip",
// 网络和地域
"net":"",  //wifi, 2g, 3g, 4g, 5g
"operator":"运营商：联通，电信等",
"location": { // 地域，可选
    "accuracy": "40",
    "horizontalAccuracy": "40",
    "latitude": "40.041912",
    "longitude": "116.266266",
    "speed": "-1",
    "verticalAccuracy": "0"
},
// 小程序基本信息
"smartAppId":"GLyLQW5hu1hvrakX0dh1E1wpRT2SPI9F_dev5774", // 小程序id, string类型
"smartAppVersion":"小程序包版本,字符串",
"swanCoreVersion":"swan框架版本",
"swanType":"swan,swangame",  // swan/swangame，小程序或者小游戏 
"swanId":"待确认", 
// 小程序事件相关信息
"bizId":"xxx", //统计事件ID，类似ubcid，根据bizId可以在管理端找到这个事件相关描述和业务含义
"eventType":"1",  //日志类型:0—普通事件类  1—流式事件类型
"eventName":"call_funnel", // 原来的打点中，type为0/1/2/3，value没有值，不清楚具体含义
 "startTime":"1456994549932", //事件上报的时间戳，单位：毫秒，整数
"endTime":"1456994549932", //事件上报的时间戳，单位：毫秒，整数
 //事件内容字段，跟具体业务相关
 "content":{
      "duration": "0.058",
      "type": "0/1/2/3",
      "ext" : {
         "thirdversion": "小程序第三方版本号",
            "needdown":"0、1（是否需要下载小程序包）"
      },
      "eventlist": [
    	{
       		"timestamp": "1532517148601",
        	"id": "start"
    	},
		{
        	"timestamp": "1532517148601",
        	"id": "scheme/aps/pkgcheck/install/narun"
    	},
    	{
        	"timestamp": "1532517294053",
        	"id": "error",
        	"value":"errcode"
    	}，
		{
        	"timestamp": "1532517294053",
        	"id": "cancel"
    	}
	]
  }
} 
```

