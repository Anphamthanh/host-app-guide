[TOC]

# 1. 定位
## 1.1. 文档版本

|文档版本|修改日期|修改概述|
|:--|:--|:--|
|0.8|2018-12-10|初始版本|
|2.7.0|2019-06-28|更新版本|

--------------------------

## 1.2. 功能说明
### 1.2.1. 功能说明
+ 小程序里提供了获取当前位置地理坐标的能力，以供小程序开发者使用，如基于定位、位置推荐的小程序等。
+ 地理位置的坐标有一定的要求，根据文档 [getLocation](https://smartprogram.baidu.com/docs/develop/api/location_get/#getLocation/) 描述，需要支持至少 wgs84 和 gcj02 两种坐标类型，默认为 wgs84 返回 gps 坐标，可选 gcj02。

### 1.2.2. 设计原理

+ 在小程序前端开发者需要使用地理位置的时候，会通过JS的调用，最终调用到端上的接口。
+ 端上的接口，会去请求定位，定位是个耗时过程，所以在定位成功之后，异步的将结果返回给开发者。

## 1.3. 开发指南
 
 + 实现BBASMLocationAdapterProtocol
 
```
/**
 * 获取定位信息-异步
 * @discussion 根据指定坐标系类型异步获取定位信息。宿主app在实现该方法时，需要添加系统定位权限相关的请求和检查，swan-native不会触发和接管权限请求。
 * @param type          坐标系类型
 * @param completion    定位结果的callback
 */
+ (void)asyncGetLocationWithType:(BBASMLocationCoordinateType)type
                      completion:(void (^)(BBASMLocationStatus status, id<BBASMLocationDataProtocol> locationData))completion;

/**
 * 获取位置信息-同步
 * @discussion 根据指定坐标系类型同步获取定位信息。。宿主app在实现该方法时，需要添加系统定位权限相关的请求和检查，swan-native不会触发和接管权限请求。
 * @param type          坐标系类型
 * @return 定位结果, 可以为nil
 */
+ (id<BBASMLocationDataProtocol>)syncGetLocationWithType:(BBASMLocationCoordinateType)type;
```
 
```
typedef NS_ENUM(NSUInteger, BBASMLocationStatus) {
    BBASMLocationStatusSuccess = 0,
    BBASMLocationStatusServicesNotDetermined,
    BBASMLocationStatusServicesDenied,
    BBASMLocationStatusServicesRestricted,
    BBASMLocationStatusServicesDisabled,
    BBASMLocationStatusError,
};

typedef NS_ENUM(NSUInteger, BBASMLocationCoordinateType) {
    BBASMLocationCoordinateTypeWGS84 = 0,
    BBASMLocationCoordinateTypeGCJ02,
    BBASMLocationCoordinateTypeBMK09MC,
};

```

+ 参考实现

```
+ (void)asyncGetLocationWithType:(BBASMLocationCoordinateType)type
                      completion:(void (^)(BBASMLocationStatus status, id<BBASMLocationDataProtocol> locationData))completion {
    //验证系统权限
    if ([CLLocationManager locationServicesEnabled] == NO) {
        completion(BBASMLocationStatusServicesDisabled, nil);
        return;
    }
    
    CLAuthorizationStatus status = [CLLocationManager authorizationStatus];
    if (status == kCLAuthorizationStatusNotDetermined) {
        [[BBALocationManager sharedInstance] requestAuthorizationIfNeeded];
    } else if (status == kCLAuthorizationStatusDenied) {
        completion(BBASMLocationStatusServicesDenied, nil);
        return;
    } else if (status == kCLAuthorizationStatusRestricted) {
        completion(BBASMLocationStatusServicesRestricted, nil);
        return;
    }
    
    [[BBALocationManager sharedInstance] requestLocationWithAccuracy:BBALocationDesiredAccuracyKilometer validPeriod:BBALocationValidPeriodOneMinute completion:^(BBALocationStatus status, BBALocationData *locationData) {
        BBASMLocationData *mnpLocation = nil;
        if (status == BBALocationStatusSuccess) {
            mnpLocation = [self convertLocationData:locationData];;
            if (type == BBASMLocationCoordinateTypeGCJ02) {
                CLLocationCoordinate2D gcj02 = [BBALocationUtility convertCoordinate:locationData.location.coordinate
                                                                             SrcType:BBALocationCoordinateTypeWGS84
                                                                             DesType:BBALocationCoordinateTypeGCJ02];
                CLLocation *oldLocation = locationData.location;
                
                mnpLocation.location = [[CLLocation alloc] initWithCoordinate:gcj02 altitude:oldLocation.altitude horizontalAccuracy:oldLocation.horizontalAccuracy verticalAccuracy:oldLocation.verticalAccuracy course:oldLocation.course speed:oldLocation.speed timestamp:oldLocation.timestamp];
            }
        }
        if (completion) {
            completion((BBASMLocationStatus)status, mnpLocation);
        }
    }];
}

+ (id<BBASMLocationDataProtocol>)syncGetLocationWithType:(BBASMLocationCoordinateType)type {
    BBALocationCoordinateType desType = BBALocationCoordinateTypeGCJ02;
    if (type == BBASMLocationCoordinateTypeBMK09MC) {
        desType = BBALocationCoordinateTypeBMK09MC;
    } else if (type == BBASMLocationCoordinateTypeWGS84) {
        desType = BBALocationCoordinateTypeWGS84;
    }
    
    BBALocationData *locationData = [[BBALocationManager sharedInstance] requestLocation];
    
    BBASMLocationData *mnpLocation = [self convertLocationData:locationData];
    if (type != BBASMLocationCoordinateTypeWGS84) {
        CLLocationCoordinate2D coordinate = [BBALocationUtility convertCoordinate:locationData.location.coordinate
                                                                          SrcType:BBALocationCoordinateTypeWGS84
                                                                          DesType:desType];
        CLLocation *oldLocation = locationData.location;
        mnpLocation.location = [[CLLocation alloc] initWithCoordinate:coordinate
                                                             altitude:oldLocation.altitude
                                                   horizontalAccuracy:oldLocation.horizontalAccuracy
                                                     verticalAccuracy:oldLocation.verticalAccuracy
                                                               course:oldLocation.course
                                                                speed:oldLocation.speed
                                                            timestamp:oldLocation.timestamp];
    }
    
    return mnpLocation;
}

+ (BBASMLocationData *)convertLocationData:(BBALocationData *)locationData {
    BBASMLocationData *mnpLocation = [[BBASMLocationData alloc] init];
    mnpLocation.location = locationData.location;
    mnpLocation.countryCode = locationData.countryCode;
    mnpLocation.country = locationData.country;
    mnpLocation.province = locationData.province;
    mnpLocation.cityCode = locationData.cityCode;
    mnpLocation.city = locationData.city;
    mnpLocation.district = locationData.district;
    mnpLocation.streetNumber = locationData.streetNumber;
    mnpLocation.street = locationData.street;
    return mnpLocation;
}
```
